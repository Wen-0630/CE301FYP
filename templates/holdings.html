{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>

<div class="row">
  <div class="col-md-12">
    <div class="x_panel">
      <div class="x_title">
        <h2>Holdings</h2>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" data-toggle="tab" href="#overview" role="tab">Holdings Overview</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#stock" role="tab">Stock Holdings</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#crypto" role="tab">Crypto Holdings</a>
          </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
          <div class="tab-pane active" id="overview" role="tabpanel">
            <h3>Holdings Overview</h3>
            <!-- Display general holdings information here -->
          </div>
          
          <!-- Stock Holdings Tab -->
          <div class="tab-pane" id="stock" role="tabpanel">
            <div class="x_panel">
              <div class="x_title">
                <h2>Stock Holdings<small>Your recent stock holdings</small></h2>
                <button class="btn btn-primary float-right" data-toggle="modal" data-target="#addStockTransactionModal">Add Stock Transaction</button>
                <div class="clearfix"></div>
              </div>
              <div class="x_content">
                <div class="card-box table-responsive">
                  <p class="text-muted font-13 m-b-30">
                      Use the table below to view, filter, and manage your stock.
                  </p>
                  <table id="stockHoldingsTable" class="table table-striped table-bordered" style="width:100%">
                    <thead>
                      <tr>
                        <th>Asset</th>
                        <th>Date & Time</th>
                        <th>Buy Price Per Unit</th>
                        <th>Quantity</th>
                        <th>Total Amount Bought</th>
                        <th>Transaction Fee</th>
                        <th>Deduct Current Cash</th>
                        <th>Current Profit/Loss</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if holdings['stock_holdings'] %}
                      {% for holding in holdings['stock_holdings'] %}
                      <tr>
                        <td>{{ holding['asset'] | capitalize }}</td>
                        <td>{{ holding['datetime'] }}</td>
                        <td>{{ holding['buy_price'] | currency_with_decimals }}</td>
                        <td>{{ holding['quantity'] | currency_with_decimals }}</td>
                        <td>{{ holding['amount_bought'] | currency_with_decimals }}</td>
                        <td>{{ holding['transaction_fee'] | currency_with_decimals }}</td>
                        <td>{{ holding['deduct_cash'] }}</td>
                        <td>{{ holding['profit_loss'] | default(0) | currency_with_decimals }}</td>
                        <td>
                          <button class="btn btn-danger btn-sm" data-id="{{ holding['_id'] }}" data-type="stock" onclick="deleteHolding(this)">Delete</button>
                        </td>
                      </tr>
                      {% endfor %}
                      {% else %}
                      <tr>
                        <td colspan="9">No stock holdings found.</td>
                      </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Crypto Holdings Tab -->
          <div class="tab-pane" id="crypto" role="tabpanel">
            <div class="x_panel">
              <div class="x_title">
                <h2>Crypto Holdings<small>Your recent crypto holdings</small></h2>
                <button class="btn btn-primary float-right" data-toggle="modal" data-target="#addCryptoTransactionModal">Add Crypto Transaction</button>
                <div class="clearfix"></div>
              </div>
              <div class="x_content">
                <div class="card-box table-responsive">
                  <p class="text-muted font-13 m-b-30">
                      Use the table below to view, filter, and manage your crypto.
                  </p>
                  <table id="cryptoHoldingsTable" class="table table-striped table-bordered" style="width:100%">
                    <thead>
                      <tr>
                        <th>Asset</th>
                        <th>Date & Time</th>
                        <th>Buy Price Per Unit</th>
                        <th>Quantity</th>
                        <th>Total Amount Bought</th>
                        <th>Transaction Fee</th>
                        <th>Deduct Current Cash</th>
                        <th>Current Profit/Loss</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if holdings['crypto_holdings'] %}
                      {% for holding in holdings['crypto_holdings'] %}
                      <tr>
                        <td>{{ holding['asset'] | capitalize }}</td>
                        <td>{{ holding['datetime'] }}</td>
                        <td>{{ holding['buy_price'] | currency_with_decimals }}</td>
                        <td>{{ holding['quantity'] | currency_with_decimals }}</td>
                        <td>{{ holding['amount_bought'] | currency_with_decimals }}</td>
                        <td>{{ holding['transaction_fee'] | currency_with_decimals }}</td>
                        <td>{{ holding['deduct_cash'] }}</td>
                        <td>{{ holding['profit_loss'] | default(0) | currency_with_decimals }}</td>
                        <td>
                          <button class="btn btn-danger btn-sm" data-id="{{ holding['_id'] }}" data-type="crypto" onclick="deleteHolding(this)">Delete</button>
                        </td>
                      </tr>
                      {% endfor %}
                      {% else %}
                      <tr>
                        <td colspan="9">No crypto holdings found.</td>
                      </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>          
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Stock Transaction Modal -->
<div class="modal fade" id="addStockTransactionModal" tabindex="-1" role="dialog" aria-labelledby="addStockTransactionModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addStockTransactionModalLabel">Add Stock Transaction</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="addStockTransactionForm">
          <input type="hidden" id="transactionTypeStock" name="transactionType" value="stock">
          <div class="form-group">
            <label for="stockSelect">Select Stock</label>
            <select id="stockSelect" class="form-control" required>
              <option value="" disabled selected>Select a stock</option>
              {% for stock in stocks_data %}
              <option value="{{ stock['symbol'] }}">{{ stock['symbol'] }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="stockTransactionDate">Date</label>
            <input type="date" id="stockTransactionDate" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="stockTransactionTime">Time</label>
            <input type="time" id="stockTransactionTime" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="stockBuyPrice">Buy Price per Unit</label>
            <input type="number" step="0.0001" id="stockBuyPrice" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="stockAmountBought">Total Amount Bought</label>
            <input type="number" step="0.0001" id="stockAmountBought" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="stockTransactionFee">Transaction Fee (Optional)</label>
            <input type="number" step="0.01" id="stockTransactionFee" class="form-control">
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="stockDeductCash">
            <label class="form-check-label" for="stockDeductCash">Deduct from available cash</label>
          </div>
          <button type="submit" class="btn btn-primary">Add Transaction</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Add Crypto Transaction Modal -->
<div class="modal fade" id="addCryptoTransactionModal" tabindex="-1" role="dialog" aria-labelledby="addCryptoTransactionModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCryptoTransactionModalLabel">Add Crypto Transaction</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="addCryptoTransactionForm">
          <input type="hidden" id="transactionTypeCrypto" name="transactionType" value="crypto">
          <div class="form-group">
            <label for="cryptoSelect">Select Crypto</label>
            <select id="cryptoSelect" class="form-control" required>
              <option value="" disabled selected>Select a crypto</option>
              {% for crypto in crypto_data %}
              <option value="{{ crypto['id'] }}">{{ crypto['name'] }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="cryptoTransactionDate">Date</label>
            <input type="date" id="cryptoTransactionDate" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="cryptoTransactionTime">Time</label>
            <input type="time" id="cryptoTransactionTime" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="cryptoBuyPrice">Buy Price per Unit</label>
            <input type="number" step="0.0001" id="cryptoBuyPrice" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="cryptoAmountBought">Total Amount Bought</label>
            <input type="number" step="0.0001" id="cryptoAmountBought" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="cryptoTransactionFee">Transaction Fee (Optional)</label>
            <input type="number" step="0.01" id="cryptoTransactionFee" class="form-control">
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="cryptoDeductCash">
            <label class="form-check-label" for="cryptoDeductCash">Deduct from available cash</label>
          </div>
          <button type="submit" class="btn btn-primary">Add Transaction</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- <script src="https://code.jquery.com/jquery-3.5.1.js"></script> -->
<script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>

<style>
    .dataTables_wrapper .dataTables_filter label::before {
        content: '\f002'; /* Unicode for Font Awesome search icon */
        font-family: FontAwesome;
        padding-right: 5px;
    }
</style>

<script>
    $(document).ready(function() {
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            var target = $(e.target).attr("href"); // Get the tab that was activated
            
            if (target === '#stock' && !$.fn.DataTable.isDataTable('#stockHoldingsTable')) {
                $('#stockHoldingsTable').DataTable({
                    "paging": true,
                    "lengthChange": true,
                    "lengthMenu": [10, 25, 50, 100],
                    "searching": true,
                    "ordering": true,
                    "info": true,
                    "autoWidth": false,
                    "columnDefs": [{
                        "targets": -1,
                        "orderable": false
                    }]
                });
            }

            if (target === '#crypto' && !$.fn.DataTable.isDataTable('#cryptoHoldingsTable')) {
                $('#cryptoHoldingsTable').DataTable({
                    "paging": true,
                    "lengthChange": true,
                    "lengthMenu": [10, 25, 50, 100],
                    "searching": true,
                    "ordering": true,
                    "info": true,
                    "autoWidth": false,
                    "columnDefs": [{
                        "targets": -1,
                        "orderable": false
                    }]
                });
            }
        });
    });


    document.getElementById('addStockTransactionForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const stockSelect = document.getElementById('stockSelect').value;
        const transactionDate = document.getElementById('stockTransactionDate').value;
        const transactionTime = document.getElementById('stockTransactionTime').value;
        const buyPrice = document.getElementById('stockBuyPrice').value;
        const amountBought = document.getElementById('stockAmountBought').value;
        const transactionFee = document.getElementById('stockTransactionFee').value;
        const deductCash = document.getElementById('stockDeductCash').checked;
        const transactionType = document.getElementById('transactionTypeStock').value;

        const transactionData = {
            type: transactionType,
            asset: stockSelect,
            date: transactionDate,
            time: transactionTime,
            buyPrice: parseFloat(buyPrice).toFixed(4),  // Ensure it handles decimal points
            amountBought: parseFloat(amountBought).toFixed(4),  // Ensure it handles decimal points
            transactionFee: transactionFee ? parseFloat(transactionFee).toFixed(2) : 0, 
            deductCash: deductCash
        };

        fetch('/add_transaction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(transactionData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Transaction added successfully');
                location.reload();
            } else {
                alert('Error adding transaction: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

    document.getElementById('addCryptoTransactionForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const cryptoSelect = document.getElementById('cryptoSelect').value;
        const transactionDate = document.getElementById('cryptoTransactionDate').value;
        const transactionTime = document.getElementById('cryptoTransactionTime').value;
        const buyPrice = document.getElementById('cryptoBuyPrice').value;
        const amountBought = document.getElementById('cryptoAmountBought').value;
        const transactionFee = document.getElementById('cryptoTransactionFee').value;
        const deductCash = document.getElementById('cryptoDeductCash').checked;
        const transactionType = document.getElementById('transactionTypeCrypto').value;

        const transactionData = {
            type: transactionType,
            asset: cryptoSelect,
            date: transactionDate,
            time: transactionTime,
            buyPrice: parseFloat(buyPrice).toFixed(4),  // Ensure it handles decimal points
            amountBought: parseFloat(amountBought).toFixed(4),  // Ensure it handles decimal points
            transactionFee: transactionFee ? parseFloat(transactionFee).toFixed(2) : 0, 
            deductCash: deductCash
        };

        fetch('/add_transaction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(transactionData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Transaction added successfully');
                location.reload();
            } else {
                alert('Error adding transaction: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

    function deleteHolding(button) {
        const id = button.getAttribute('data-id');
        const type = button.getAttribute('data-type');
        const url = type === 'stock' ? '/delete_stock_holding' : '/delete_crypto_holding';
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ holdingId: id })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Holding deleted successfully');
                location.reload();
            } else {
                alert('Error deleting holding: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
</script>

{% endblock %}
